<!DOCTYPE html>
<html ng-app="acComponentsExampleApp">
    <head>
        <title>acComponents Example</title>
        <link href="./css/vendor.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="css/ac-theme.css">
        <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
        <style type="text/css">
            html, body {
                height: 100%;
                width: 100%;
                padding: 0;
                margin: 0;
            }

            #map {
                height: 100%;
                width: 100%;
            }
        </style>
    </head>
    <body ng-controller="exampleController">
        <div ac-mapbox-map ac-map-sidebar="sidebar" ac-regions="regions" ac-region="current.region" obs="obs"></div>
        <div ac-drawer ng-class="{'ac-drawer--expanded': current.region && current.region.feature.properties.forecast && drawer.visible}">
            <div ac-forecast-mini ac-forecast="current.region.feature.properties.forecast"></div>
        </div>
        <script src="js/geojson-utils.js"></script>
        <script src="./js/vendor.js"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.2.0/js/bootstrap.js"></script>
        <script src="./js/ac-components.js"></script>
        <script>
            angular.module('acComponentsExampleApp', ['acComponents'])
                .constant('MAPBOX_ACCESS_TOKEN', 'pk.eyJ1IjoiYXZhbGFuY2hlY2FuYWRhIiwiYSI6Im52VjFlWW8ifQ.-jbec6Q_pA7uRgvVDkXxsA')
                .constant('MAPBOX_MAP_ID', 'tesera.jbnoj7kp')
                .constant('AC_API_ROOT_URL', 'http://localhost:9000')

                .controller('exampleController', function ($scope, $timeout, acForecast, acObservation) {
                    $scope.current = {
                        region: {}
                    };
                    $scope.drawer = {
                        visible: false
                    };

                    acForecast.fetch().then(function (forecasts) {
                        $scope.regions = forecasts;
                    });

                    $scope.$watch('current.region', function (newRegion, oldRegion) {
                        if(newRegion && newRegion !== oldRegion) {
                            $scope.drawer.visible = false;
                            $scope.imageLoaded = false;

                            if(!newRegion.feature.properties.forecast) {
                                acForecast.getOne(newRegion.feature.id).then(function (forecast) {
                                    newRegion.feature.properties.forecast = forecast;
                                });
                            }

                            $timeout(function () {
                                $scope.drawer.visible = true;
                            }, 800);
                        }
                    });

                    acObservation.byPeriod('2:days').then(function (obs) {
                        $scope.obs = obs;
                    });
                });
        </script>
    </body>
</html>